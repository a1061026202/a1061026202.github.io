<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>MyCat-高可用集群搭建、架构剖析 | ZC的学习录</title><meta name="keywords" content="高可用集群"><meta name="author" content="zhangc233"><meta name="copyright" content="zhangc233"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="MyCat高可用集群搭建集群架构MyCat实现读写分离架构在之前的笔记中， 已经讲解过了通过MyCat来实现MySQL的读写分离，从而完成MySQL集群的负载均衡， 如下面的结构图：     但是以上架构存在问题 ，由于MyCat中间件是单节点的服务，前端客户端所有的压力过来都直接请求这一台MyCat，存在单点故障。所以这个时候， 我们就需要考虑MyCat的集群 。 MyCat集群架构通过MyCa">
<meta property="og:type" content="article">
<meta property="og:title" content="MyCat-高可用集群搭建、架构剖析">
<meta property="og:url" content="https://zhangc233.github.io/2021/05/26/MyCat%E2%80%94%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E5%8F%8A%E6%9E%B6%E6%9E%84%E5%89%96%E6%9E%90/index.html">
<meta property="og:site_name" content="ZC的学习录">
<meta property="og:description" content="MyCat高可用集群搭建集群架构MyCat实现读写分离架构在之前的笔记中， 已经讲解过了通过MyCat来实现MySQL的读写分离，从而完成MySQL集群的负载均衡， 如下面的结构图：     但是以上架构存在问题 ，由于MyCat中间件是单节点的服务，前端客户端所有的压力过来都直接请求这一台MyCat，存在单点故障。所以这个时候， 我们就需要考虑MyCat的集群 。 MyCat集群架构通过MyCa">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/mycat.jpg">
<meta property="article:published_time" content="2021-05-26T13:00:00.000Z">
<meta property="article:modified_time" content="2021-05-29T14:01:23.131Z">
<meta property="article:author" content="zhangc233">
<meta property="article:tag" content="数据库中间件">
<meta property="article:tag" content="MyCat">
<meta property="article:tag" content="高可用集群">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/mycat.jpg"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://zhangc233.github.io/2021/05/26/MyCat%E2%80%94%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E5%8F%8A%E6%9E%B6%E6%9E%84%E5%89%96%E6%9E%90/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="yandex-verification" content="{&quot;theme_color&quot;:{&quot;enable&quot;:true,&quot;main&quot;:&quot;#49B1F5&quot;,&quot;paginator&quot;:&quot;#00c4b6&quot;,&quot;button_hover&quot;:&quot;#FF7242&quot;,&quot;text_selection&quot;:&quot;#00c4b6&quot;,&quot;link_color&quot;:&quot;#99a9bf&quot;,&quot;meta_color&quot;:&quot;#858585&quot;,&quot;hr_color&quot;:&quot;#A4D8FA&quot;,&quot;code_foreground&quot;:&quot;#F47466&quot;,&quot;code_background&quot;:&quot;rgba(27, 31, 35, .05)&quot;,&quot;toc_color&quot;:&quot;#00c4b6&quot;,&quot;blockquote_padding_color&quot;:&quot;#49b1f5&quot;,&quot;blockquote_background_color&quot;:&quot;#49b1f5&quot;}}"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?fbe67500831b74f989430bb8dbe1e7ca";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: zhangc233","link":"链接: ","source":"来源: ZC的学习录","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-05-29 22:01:23'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    })(window)</script><link rel="stylesheet" href="/css/Lete.css"><link rel="stylesheet" href="/css/card_botui.css" /><link rel="stylesheet" href="/css/iconfont.css" /><style type="text/css">#toggle-sidebar {bottom: 80px}</style><style type="text/css">#toggle-sidebar {left:100px}</style><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">29</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">57</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont  icon-shouye_huaban1"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont  icon-timeAxis"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw iconfont  icon-biaoqian_huaban1"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw iconfont  icon-quanbu"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-yinle"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw iconfont  icon-yinle1"></i><span> 音乐</span></a></li><li><a class="site-page" href="/gallery/"><i class="fa-fw iconfont  icon-xiangce"></i><span> 相册</span></a></li><li><a class="site-page" href="/FilmAndTV/"><i class="fa-fw iconfont  icon-wodezhuifan"></i><span> 追番</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont  icon-lianjie-tianchong"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont  icon-guanyu1"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/mycat.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">ZC的学习录</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw iconfont  icon-shouye_huaban1"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont  icon-timeAxis"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw iconfont  icon-biaoqian_huaban1"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw iconfont  icon-quanbu"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw iconfont icon-yinle"></i><span> 生活</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw iconfont  icon-yinle1"></i><span> 音乐</span></a></li><li><a class="site-page" href="/gallery/"><i class="fa-fw iconfont  icon-xiangce"></i><span> 相册</span></a></li><li><a class="site-page" href="/FilmAndTV/"><i class="fa-fw iconfont  icon-wodezhuifan"></i><span> 追番</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw iconfont  icon-lianjie-tianchong"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw iconfont  icon-guanyu1"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">MyCat-高可用集群搭建、架构剖析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-05-26T13:00:00.000Z" title="发表于 2021-05-26 21:00:00">2021-05-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-05-29T14:01:23.131Z" title="更新于 2021-05-29 22:01:23">2021-05-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/MyCat/">MyCat</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>34分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="MyCat高可用集群搭建"><a href="#MyCat高可用集群搭建" class="headerlink" title="MyCat高可用集群搭建"></a>MyCat高可用集群搭建</h2><h3 id="集群架构"><a href="#集群架构" class="headerlink" title="集群架构"></a>集群架构</h3><h4 id="MyCat实现读写分离架构"><a href="#MyCat实现读写分离架构" class="headerlink" title="MyCat实现读写分离架构"></a>MyCat实现读写分离架构</h4><p>在之前的笔记中， 已经讲解过了通过MyCat来实现MySQL的读写分离，从而完成MySQL集群的负载均衡， 如下面的结构图： </p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210528142409915.png" alt="image-20210528142409915" style="zoom: 50%;" /> 

<p>但是以上架构存在问题 ，由于MyCat中间件是单节点的服务，前端客户端所有的压力过来都直接请求这一台MyCat，存在单点故障。所以这个时候， 我们就需要考虑MyCat的集群 。</p>
<h4 id="MyCat集群架构"><a href="#MyCat集群架构" class="headerlink" title="MyCat集群架构"></a>MyCat集群架构</h4><p>通过MyCat来实现后端MySQL的负载均衡 ，通过HAProxy再实现MyCat集群的负载均衡：</p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210528142453972.png" alt="image-20210528142453972" style="zoom: 45%;" /> 

<p>HAProxy 负责将请求分发到 MyCat 上，起到负载均衡的作用，同时 HAProxy 也能检测到 MyCat 是否存活，HAProxy 只会将请求转发到存活的 MyCat 上。如果一台 MyCat 服务器宕机，HAPorxy 转发请求时不会转发到宕机的 MyCat 上，所以 MyCat 依然可用。</p>
<p><strong>HAProxy介绍：</strong></p>
<p>HAProxy 是一个开源的、高性能的基于TCP(第四层)和HTTP(第七层)应用的负载均衡软件。 使用HAProxy可以快速、可靠地实现基于TCP与HTTP应用的负载均衡解决方案。</p>
<p>具有以下优点： </p>
<ol>
<li><p>可靠性和稳定性好, 可以与硬件级的F5负载均衡服务器媲美 ;</p>
</li>
<li><p>处理能力强, 最高可以通过维护4w-5w个并发连接, 单位时间处理的最大请求数达到2w个 ;</p>
</li>
<li><p>支持多种负载均衡算法 ;</p>
</li>
<li><p>有功能强大的监控界面, 通过此页面可以实时了解系统的运行情况 ;</p>
</li>
</ol>
<p>但是，上述的架构也是存在问题的， 因为所有的客户端请求都是先到达HAProxy，由HAProxy再将请求再向下分发，如果HAProxy宕机的话，就会造成整个MyCat集群不能正常运行，依然存在单点故障。</p>
<h4 id="MyCat的高可用集群"><a href="#MyCat的高可用集群" class="headerlink" title="MyCat的高可用集群"></a>MyCat的高可用集群</h4><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210528142546548.png" alt="image-20210528142546548" style="zoom: 45%;" /> 



<p><strong>图解说明：</strong></p>
<ol>
<li><p>HAProxy 实现了 MyCat 多节点的集群高可用和负载均衡，而 HAProxy 自身的高可用则可以通过Keepalived 来实现。因此，HAProxy 主机上要同时安装 HAProxy 和 Keepalived，Keepalived 负责为该服务器抢占 vip（虚拟 ip），抢占到 vip 后，对该主机的访问可以通过原来的 ip访问，也可以直接通过 vip访问。</p>
</li>
<li><p>Keepalived 抢占 vip 有优先级，由keepalived.conf 配置中的 priority 属性决定。但是一般哪台主机上的Keepalived服务先启动就会抢占到vip，即使是slave，只要先启动也能抢到（要注意避免Keepalived的资源抢占问题）。</p>
</li>
<li><p>HAProxy 负责将 vip 上的请求分发到 MyCat 集群节点上，起到负载均衡的作用。同时 HAProxy 也能检测到 MyCat 是否存活，HAProxy 只会将请求转发到存活的 MyCat 上。</p>
</li>
<li><p>如果 Keepalived+HAProxy 高可用集群中的一台服务器宕机，集群中另外一台服务器上的 Keepalived会立刻抢占 vip 并接管服务，此时抢占了 vip 的 HAProxy 节点可以继续提供服务。</p>
</li>
<li><p>如果一台 MyCat 服务器宕机，HAPorxy 转发请求时不会转发到宕机的 MyCat 上，所以 MyCat 依然可用。</p>
</li>
</ol>
<p>综上：MyCat 的高可用及负载均衡由 HAProxy 来实现，而 HAProxy 的高可用，由 Keepalived 来实现。</p>
<p><strong>keepalived介绍:</strong></p>
<ul>
<li>Keepalived是一种基于VRRP协议来实现的高可用方案,可以利用其来避免单点故障。 通常有两台甚至多台服务器运行Keepalived，一台为主服务器(Master), 其他为备份服务器, 但是对外表现为一个虚拟IP(VIP), 主服务器会发送特定的消息给备份服务器, 当备份服务器接收不到这个消息时, 即认为主服务器宕机 , 备份服务器就会接管虚拟IP, 继续提供服务, 从而保证了整个集群的高可用。</li>
<li>VRRP(虚拟路由冗余协议-Virtual Router Redundancy Protocol)协议是用于实现路由器冗余的协议，VRRP 协议将两台或多台路由器设备虚拟成一个设备，对外提供虚拟路由器 IP(一个或多个)，而在路由器组内部，如果实际拥有这个对外 IP 的路由器如果工作正常的话就是 MASTER，或者是通过算法选举产生。MASTER 实现针对虚拟路由器 IP 的各种网络功能，如 ARP 请求，ICMP，以及数据的转发等；其他设备不拥有该虚拟 IP，状态是 BACKUP，除了接收 MASTER 的VRRP 状态通告信息外，不执行对外的网络功能。当主机失效时，BACKUP 将接管原先 MASTER 的网络功能。</li>
<li>VRRP 协议使用多播数据来传输 VRRP 数据，VRRP 数据使用特殊的虚拟源 MAC 地址发送数据而不是自身网卡的 MAC 地址，VRRP 运行时只有 MASTER 路由器定时发送 VRRP 通告信息，表示 MASTER 工作正常以及虚拟路由器 IP(组)，BACKUP 只接收 VRRP 数据，不发送数据，如果一定时间内没有接收到 MASTER 的通告信息，各 BACKUP 将宣告自己成为 MASTER，发送通告信息，重新进行 MASTER 选举状态。</li>
</ul>
<h3 id="高可用集群搭建"><a href="#高可用集群搭建" class="headerlink" title="高可用集群搭建"></a>高可用集群搭建</h3><h4 id="部署环境规划"><a href="#部署环境规划" class="headerlink" title="部署环境规划"></a>部署环境规划</h4><table>
<thead>
<tr>
<th align="left">名称</th>
<th align="center">IP</th>
<th align="center">端口</th>
<th align="center">用户名/密码</th>
</tr>
</thead>
<tbody><tr>
<td align="left">MySQL Master</td>
<td align="center">192.168.192.157</td>
<td align="center">3306</td>
<td align="center">root/123456</td>
</tr>
<tr>
<td align="left">MySQL Slave</td>
<td align="center">192.168.192.158</td>
<td align="center">3306</td>
<td align="center">root/123456</td>
</tr>
<tr>
<td align="left">MyCat节点1</td>
<td align="center">192.168.192.157</td>
<td align="center">8066</td>
<td align="center">root/123456</td>
</tr>
<tr>
<td align="left">MyCat节点2</td>
<td align="center">192.168.192.158</td>
<td align="center">8066</td>
<td align="center">root/123456</td>
</tr>
<tr>
<td align="left">HAProxy节点1/keepalived主</td>
<td align="center">192.168.192.159</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="left">HAProxy节点2/keepalived备</td>
<td align="center">192.168.192.160</td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody></table>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210528142700817.png" alt="image-20210528142700817" style="zoom:50%;" /> 



<h4 id="MySQL主从复制搭建"><a href="#MySQL主从复制搭建" class="headerlink" title="MySQL主从复制搭建"></a>MySQL主从复制搭建</h4><p>环境搭建之前需要每台服务器上都已经安装MySQL。</p>
<h5 id="master"><a href="#master" class="headerlink" title="master"></a>master</h5><ol>
<li>在master 的配置文件（/usr/my.cnf）中，配置如下内容：</li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysql 服务ID,保证整个集群环境中唯一</span></span><br><span class="line"><span class="meta">server-id</span>=<span class="string">1</span></span><br><span class="line"><span class="comment">#mysql binlog 日志的存储路径和文件名</span></span><br><span class="line"><span class="meta">log-bin</span>=<span class="string">/var/lib/mysql/mysqlbin</span></span><br><span class="line"><span class="comment">#设置logbin格式</span></span><br><span class="line"><span class="attr">binlog_format</span>=<span class="string">STATEMENT</span></span><br><span class="line"><span class="comment">#是否只读,1 代表只读, 0 代表读写</span></span><br><span class="line"><span class="meta">read-only</span>=<span class="string">0</span></span><br><span class="line"><span class="comment">#指定同步的数据库</span></span><br><span class="line"><span class="meta">binlog-do-db</span>=<span class="string">db01</span></span><br><span class="line"><span class="meta">binlog-do-db</span>=<span class="string">db02</span></span><br><span class="line"><span class="meta">binlog-do-db</span>=<span class="string">db03</span></span><br></pre></td></tr></table></figure>



<ol start="2">
<li>执行完毕之后，需要重启MySQL：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysql restart ;</span><br></pre></td></tr></table></figure>



<ol start="3">
<li>创建同步数据的账户，并且进行授权操作：</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;itcast&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123456;	</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">flush privileges;</span></span><br></pre></td></tr></table></figure>



<ol start="4">
<li>查看master状态：</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> master status;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210528142344820.png" alt="image-20210528142344820">  </p>
<p>字段含义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">File : 从哪个日志文件开始推送日志文件 </span><br><span class="line">Position ： 从哪个位置开始推送日志</span><br><span class="line">Binlog_Do_DB : 指定需要同步的数据库</span><br></pre></td></tr></table></figure>



<h5 id="slave"><a href="#slave" class="headerlink" title="slave"></a>slave</h5><ol>
<li>在 slave 端配置文件中，配置如下内容：</li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysql服务端ID,唯一</span></span><br><span class="line"><span class="meta">server-id</span>=<span class="string">2</span></span><br><span class="line"><span class="comment">#指定binlog日志</span></span><br><span class="line"><span class="meta">log-bin</span>=<span class="string">/var/lib/mysql/mysqlbin</span></span><br><span class="line"><span class="comment">#启用中继日志</span></span><br><span class="line"><span class="meta">relay-log</span>=<span class="string">mysql-relay</span></span><br></pre></td></tr></table></figure>



<ol start="2">
<li>执行完毕之后，需要重启MySQL：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysql restart;</span><br></pre></td></tr></table></figure>



<ol start="3">
<li>执行如下指令 ：</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#指定当前从库对应的主库的IP地址，用户名，密码，从哪个日志文件开始的那个位置开始同步推送日志。</span><br><span class="line">change master <span class="keyword">to</span> master_host<span class="operator">=</span> <span class="string">&#x27;192.168.192.157&#x27;</span>, master_user<span class="operator">=</span><span class="string">&#x27;itcast&#x27;</span>, master_password<span class="operator">=</span><span class="string">&#x27;123456&#x27;</span>, master_log_file<span class="operator">=</span><span class="string">&#x27;mysqlbin.000002&#x27;</span>, master_log_pos<span class="operator">=</span><span class="number">120</span>;</span><br></pre></td></tr></table></figure>

<p>但是如果之前节点之间有主从复制关系，需要先停止两者的联系：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stop slave;</span><br><span class="line">reset master;</span><br></pre></td></tr></table></figure>



<ol start="4">
<li>开启同步操作：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start slave;</span><br><span class="line">show slave status;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210528143557533.png" alt="image-20210528143557533"></p>
<h5 id="测试验证"><a href="#测试验证" class="headerlink" title="测试验证"></a>测试验证</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">create database db01;</span><br><span class="line"></span><br><span class="line">user db01;</span><br><span class="line"></span><br><span class="line"><span class="function">create table <span class="title">user</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	id <span class="keyword">int</span>(<span class="number">11</span>)</span> not <span class="keyword">null</span> auto_increment,</span></span><br><span class="line"><span class="function">	name <span class="title">varchar</span><span class="params">(<span class="number">50</span>)</span> not <span class="keyword">null</span>,</span></span><br><span class="line"><span class="function">	sex <span class="title">varchar</span><span class="params">(<span class="number">1</span>)</span>,</span></span><br><span class="line"><span class="function">	primary <span class="title">key</span> <span class="params">(id)</span></span></span><br><span class="line"><span class="function">)engine</span>=innodb <span class="keyword">default</span> charset=utf8;</span><br><span class="line"></span><br><span class="line"><span class="function">insert into <span class="title">user</span><span class="params">(id,name,sex)</span> <span class="title">values</span><span class="params">(<span class="keyword">null</span>,<span class="string">&#x27;Tom&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span></span>;</span><br><span class="line"><span class="function">insert into <span class="title">user</span><span class="params">(id,name,sex)</span> <span class="title">values</span><span class="params">(<span class="keyword">null</span>,<span class="string">&#x27;Trigger&#x27;</span>,<span class="string">&#x27;0&#x27;</span>)</span></span>;</span><br><span class="line"><span class="function">insert into <span class="title">user</span><span class="params">(id,name,sex)</span> <span class="title">values</span><span class="params">(<span class="keyword">null</span>,<span class="string">&#x27;Dawn&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span></span>;</span><br></pre></td></tr></table></figure>

<p>在主节点以及从节点上都可以查到数据：</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210528143435791.png" alt="image-20210528143435791"></p>
<h4 id="MyCat安装配置"><a href="#MyCat安装配置" class="headerlink" title="MyCat安装配置"></a>MyCat安装配置</h4><h5 id="schema-xml"><a href="#schema-xml" class="headerlink" title="schema.xml"></a>schema.xml</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mycat</span>:schema <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;ITCAST&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db01&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;localhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;1&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> 	</span></span><br><span class="line"><span class="tag">				<span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.192.157:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.192.158:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h5 id="server-xml"><a href="#server-xml" class="headerlink" title="server.xml"></a>server.xml</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>ITCAST<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;test&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>ITCAST<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>两台服务器均需要安装MyCat（依赖JDK）、JDK，并且MyCat服务做相同的配置 。MyCat、JDK安装见本博客的MyCat入门文档。</p>
<h5 id="测试验证-1"><a href="#测试验证-1" class="headerlink" title="测试验证"></a>测试验证</h5><ol>
<li><p>两台服务器均启动MyCat：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bin/mycat start;</span><br><span class="line">mysql -h 192.168.192.157/8 -P 8066 -u root -p;</span><br></pre></td></tr></table></figure></li>
<li><p>通过查看日志验证环境是否搭建成功（记得修改日志级别为：DEBUG）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(id,name,sex) <span class="keyword">values</span>(<span class="keyword">null</span>,<span class="string">&#x27;Tom2&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210528145225031.png" alt="image-20210528145225031"></p>
<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210528145515739.png" alt="image-20210528145515739"></p>
<p>读操作走从节点，写操作走主节点。</p>
</li>
</ol>
<h4 id="HAProxy安装配置"><a href="#HAProxy安装配置" class="headerlink" title="HAProxy安装配置"></a>HAProxy安装配置</h4><h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><ol>
<li>准备好HAProxy安装包，分别上传到两台服务器（192.168.192.159/160都安装）的/root目录下：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">haproxy-1.5.16.tar.gz</span><br></pre></td></tr></table></figure>



<ol start="2">
<li>解压到/usr/local/src目录下：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf haproxy-1.5.16.tar.gz -C /usr/local/src</span><br></pre></td></tr></table></figure>



<ol start="3">
<li>进入解压后的目录，查看内核版本，进行编译：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/haproxy-1.5.16</span><br><span class="line">uname -r</span><br><span class="line">make TARGET=linux2632 PREFIX=/usr/local/haproxy ARCH=x86_64</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> TARGET=linux310，内核版本，使用uname -r查看内核，如：2.6.32-431.el6.x86_64，此时该参数就为linux2632；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ARCH=x86_64:系统位数；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> PREFIX=/usr/<span class="built_in">local</span>/haprpxy <span class="comment">#/usr/local/haprpxy，为haprpxy安装路径。</span></span></span><br></pre></td></tr></table></figure>



<ol start="4">
<li>编译完成后，进行安装：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make install PREFIX=/usr/local/haproxy</span><br></pre></td></tr></table></figure>



<ol start="5">
<li>安装完成后，创建目录：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /usr/data/haproxy/</span><br></pre></td></tr></table></figure>



<ol start="6">
<li>创建HAProxy配置文件：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/haproxy/haproxy.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">global</span></span><br><span class="line">	<span class="string">log</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="string">local0</span> </span><br><span class="line">	<span class="string">maxconn</span> <span class="number">4096</span> </span><br><span class="line">	<span class="string">chroot</span> <span class="string">/usr/local/haproxy</span> </span><br><span class="line">	<span class="string">pidfile</span> <span class="string">/usr/data/haproxy/haproxy.pid</span></span><br><span class="line">	<span class="string">uid</span> <span class="number">99</span></span><br><span class="line">	<span class="string">gid</span> <span class="number">99</span></span><br><span class="line">	<span class="string">daemon</span></span><br><span class="line">	<span class="string">node</span> <span class="string">mysql-haproxy-01</span></span><br><span class="line">	<span class="string">description</span> <span class="string">mysql-haproxy-01</span></span><br><span class="line"><span class="string">defaults</span></span><br><span class="line">	<span class="string">log</span> <span class="string">global</span></span><br><span class="line">	<span class="string">mode</span> <span class="string">tcp</span></span><br><span class="line">	<span class="string">option</span> <span class="string">abortonclose</span></span><br><span class="line">	<span class="string">option</span> <span class="string">redispatch</span></span><br><span class="line">	<span class="string">retries</span> <span class="number">3</span></span><br><span class="line">	<span class="string">maxconn</span> <span class="number">2000</span></span><br><span class="line">	<span class="string">timeout</span> <span class="string">connect</span> <span class="string">50000ms</span></span><br><span class="line">	<span class="string">timeout</span> <span class="string">client</span> <span class="string">50000ms</span></span><br><span class="line">	<span class="string">timeout</span> <span class="string">server</span> <span class="string">50000ms</span></span><br><span class="line"><span class="string">listen</span> <span class="string">proxy_status</span></span><br><span class="line">	<span class="string">bind</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:48066</span></span><br><span class="line">		<span class="string">mode</span> <span class="string">tcp</span></span><br><span class="line">		<span class="string">balance</span> <span class="string">roundrobin</span></span><br><span class="line">		<span class="string">server</span> <span class="string">mycat_1</span> <span class="number">192.168</span><span class="number">.192</span><span class="number">.157</span><span class="string">:8066</span> <span class="string">check</span></span><br><span class="line">		<span class="string">server</span> <span class="string">mycat_2</span> <span class="number">192.168</span><span class="number">.192</span><span class="number">.158</span><span class="string">:8066</span> <span class="string">check</span></span><br><span class="line"><span class="string">frontend</span> <span class="string">admin_stats</span></span><br><span class="line">	<span class="string">bind</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:8888</span></span><br><span class="line">		<span class="string">mode</span> <span class="string">http</span></span><br><span class="line">		<span class="string">stats</span> <span class="string">enable</span></span><br><span class="line">		<span class="string">option</span> <span class="string">httplog</span></span><br><span class="line">		<span class="string">maxconn</span> <span class="number">10</span></span><br><span class="line">		<span class="string">stats</span> <span class="string">refresh</span> <span class="string">30s</span></span><br><span class="line">		<span class="string">stats</span> <span class="string">uri</span> <span class="string">/admin</span></span><br><span class="line">		<span class="string">stats</span> <span class="string">auth</span> <span class="string">admin:123123</span></span><br><span class="line">		<span class="string">stats</span> <span class="string">hide-version</span></span><br><span class="line">		<span class="string">stats</span> <span class="string">admin</span> <span class="string">if</span> <span class="literal">TRUE</span></span><br></pre></td></tr></table></figure>



<p><strong>内容解析如下</strong> : </p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#global 配置中的参数为进程级别的参数，通常与其运行的操作系统有关</span></span><br><span class="line"><span class="string">global</span></span><br><span class="line">	<span class="comment">#定义全局的syslog服务器, 最多可定义2个; local0 是日志设备, 对应于/etc/rsyslog.conf中的配置 , 默认收集info级别日志</span></span><br><span class="line">	<span class="string">log</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="string">local0</span> </span><br><span class="line">	<span class="comment">#log 127.0.0.1 local1 notice</span></span><br><span class="line">	<span class="comment">#log loghost local0 info</span></span><br><span class="line">	<span class="comment">#设定每个haproxy进程所接受的最大并发连接数 ;</span></span><br><span class="line">	<span class="string">maxconn</span> <span class="number">4096</span> </span><br><span class="line">	<span class="comment">#修改HAproxy工作目录至指定的目录并在放弃权限之前执行chroot操作, 可以提升haproxy的安全级别</span></span><br><span class="line">	<span class="string">chroot</span> <span class="string">/usr/local/haproxy</span> </span><br><span class="line">	<span class="comment">#进程ID保存文件</span></span><br><span class="line">	<span class="string">pidfile</span> <span class="string">/usr/data/haproxy/haproxy.pid</span></span><br><span class="line">	<span class="comment">#指定用户ID</span></span><br><span class="line">	<span class="string">uid</span> <span class="number">99</span></span><br><span class="line">	<span class="comment">#指定组ID</span></span><br><span class="line">	<span class="string">gid</span> <span class="number">99</span></span><br><span class="line">	<span class="comment">#设置HAproxy以守护进程方式运行</span></span><br><span class="line">	<span class="string">daemon</span></span><br><span class="line">	<span class="comment">#debug</span></span><br><span class="line">	<span class="comment">#quiet</span></span><br><span class="line">	<span class="string">node</span> <span class="string">mysql-haproxy-01</span>  <span class="comment">## 定义当前节点的名称，用于 HA 场景中多 haproxy 进程共享同一个 IP 地址时</span></span><br><span class="line">	<span class="string">description</span> <span class="string">mysql-haproxy-01</span> <span class="comment">## 当前实例的描述信息</span></span><br><span class="line">	</span><br><span class="line"><span class="comment">#defaults：用于为所有其他配置段提供默认参数，这默认配置参数可由下一个&quot;defaults&quot;所重新设定</span></span><br><span class="line"><span class="string">defaults</span></span><br><span class="line">	<span class="comment">#继承global中的log定义</span></span><br><span class="line">	<span class="string">log</span> <span class="string">global</span></span><br><span class="line">	<span class="comment">#所使用的处理模式(tcp:四层 , http:七层, health:状态检查,只返回OK)</span></span><br><span class="line">	<span class="comment">### tcp: 实例运行于纯 tcp 模式，在客户端和服务器端之间将建立一个全双工的连接，且不会对 7 层报文做任何类型的检查，此为默认模式</span></span><br><span class="line">	<span class="comment">### http:实例运行于 http 模式，客户端请求在转发至后端服务器之前将被深度分析，所有不与 RFC 模式兼容的请求都会被拒绝</span></span><br><span class="line">	<span class="comment">### health：实例运行于 health 模式，其对入站请求仅响应“OK”信息并关闭连接，且不会记录任何日志信息 ，此模式将用于相应外部组件的监控状态检测请求</span></span><br><span class="line">	<span class="string">mode</span> <span class="string">tcp</span></span><br><span class="line">	<span class="comment">#当服务器负载很高的时候，自动结束掉当前队列处理时间比较长的连接</span></span><br><span class="line">	<span class="string">option</span> <span class="string">abortonclose</span></span><br><span class="line">		</span><br><span class="line">	<span class="comment">#当使用了cookie时，haproxy将会将请求的后端服务器的serverID插入到cookie中，以保证会话的session持久性，而此时，后端服务器宕机，但是客户端的cookie不会刷新，设置此参数，将会将客户请求强制定向到另外一个后端server上，以保证服务的正常。</span></span><br><span class="line">	<span class="string">option</span> <span class="string">redispatch</span></span><br><span class="line">	<span class="string">retries</span> <span class="number">3</span></span><br><span class="line">	<span class="comment"># 前端的最大并发连接数（默认为 2000）</span></span><br><span class="line">	<span class="string">maxconn</span> <span class="number">2000</span></span><br><span class="line">	<span class="comment"># 连接超时(默认是毫秒,单位可以设置 us,ms,s,m,h,d)</span></span><br><span class="line">	<span class="string">timeout</span> <span class="string">connect</span> <span class="number">5000</span></span><br><span class="line">	<span class="comment"># 客户端超时时间</span></span><br><span class="line">	<span class="string">timeout</span> <span class="string">client</span> <span class="number">50000</span></span><br><span class="line">	<span class="comment"># 服务器超时时间</span></span><br><span class="line">	<span class="string">timeout</span> <span class="string">server</span> <span class="number">50000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#listen: 用于定义通过关联“前端”和“后端”一个完整的代理，通常只对 TCP 流量有用</span></span><br><span class="line"><span class="string">listen</span> <span class="string">proxy_status</span></span><br><span class="line">	<span class="string">bind</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:48066</span> <span class="comment"># 绑定端口</span></span><br><span class="line">		<span class="string">mode</span> <span class="string">tcp</span></span><br><span class="line">		<span class="string">balance</span> <span class="string">roundrobin</span> <span class="comment"># 定义负载均衡算法，可用于&quot;defaults&quot;、&quot;listen&quot;和&quot;backend&quot;中,默认为轮询</span></span><br><span class="line">		<span class="comment">#格式: server &lt;name&gt; &lt;address&gt; [:[port]] [param*]</span></span><br><span class="line">		<span class="comment"># weight : 权重，默认为 1，最大值为 256，0 表示不参与负载均衡</span></span><br><span class="line">        <span class="comment"># backup : 设定为备用服务器，仅在负载均衡场景中的其他 server 均不可以启用此 server</span></span><br><span class="line">        <span class="comment"># check  : 启动对此 server 执行监控状态检查，其可以借助于额外的其他参数完成更精细的设定</span></span><br><span class="line">        <span class="comment"># inter  : 设定监控状态检查的时间间隔，单位为毫秒，默认为 2000，也可以使用 fastinter 和 downinter 来根据服务器端专题优化此事件延迟</span></span><br><span class="line">        <span class="comment"># rise   : 设置 server 从离线状态转换至正常状态需要检查的次数（不设置的情况下，默认值为 2）</span></span><br><span class="line">        <span class="comment"># fall   : 设置 server 从正常状态转换至离线状态需要检查的次数（不设置的情况下，默认值为 3）</span></span><br><span class="line">        <span class="comment"># cookie : 为指定 server 设定 cookie 值，此处指定的值将会在请求入站时被检查，第一次为此值挑选的 server 将会被后续的请求所选中，其目的在于实现持久连接的功能</span></span><br><span class="line">        <span class="comment"># maxconn: 指定此服务器接受的最大并发连接数，如果发往此服务器的连接数目高于此处指定的值，其将被放置于请求队列，以等待其他连接被释放</span></span><br><span class="line">		<span class="string">server</span> <span class="string">mycat_1</span> <span class="number">192.168</span><span class="number">.192</span><span class="number">.157</span><span class="string">:8066</span> <span class="string">check</span> <span class="string">inter</span> <span class="string">10s</span></span><br><span class="line">		<span class="string">server</span> <span class="string">mycat_2</span> <span class="number">192.168</span><span class="number">.192</span><span class="number">.158</span><span class="string">:8066</span> <span class="string">check</span> <span class="string">inter</span> <span class="string">10s</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用来匹配接收客户所请求的域名，uri等，并针对不同的匹配，做不同的请求处理.</span></span><br><span class="line"><span class="comment"># HAProxy 的状态信息统计页面</span></span><br><span class="line"><span class="string">frontend</span> <span class="string">admin_stats</span></span><br><span class="line">	<span class="string">bind</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:8888</span></span><br><span class="line">		<span class="string">mode</span> <span class="string">http</span></span><br><span class="line">		<span class="string">stats</span> <span class="string">enable</span></span><br><span class="line">		<span class="string">option</span> <span class="string">httplog</span></span><br><span class="line">		<span class="string">maxconn</span> <span class="number">10</span></span><br><span class="line">		<span class="string">stats</span> <span class="string">refresh</span> <span class="string">30s</span></span><br><span class="line">		<span class="string">stats</span> <span class="string">uri</span> <span class="string">/admin</span></span><br><span class="line">		<span class="string">stats</span> <span class="string">auth</span> <span class="string">admin:123123</span></span><br><span class="line">		<span class="string">stats</span> <span class="string">hide-version</span></span><br><span class="line">		<span class="string">stats</span> <span class="string">admin</span> <span class="string">if</span> <span class="literal">TRUE</span></span><br></pre></td></tr></table></figure>



<p>HAProxy的负载均衡策略：</p>
<table>
<thead>
<tr>
<th>策略</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>roundrobin</td>
<td>表示简单的轮循，即客户端每访问一次，请求轮循跳转到后端不同的节点机器上</td>
</tr>
<tr>
<td>static-rr</td>
<td>基于权重轮循，根据权重轮循调度到后端不同节点</td>
</tr>
<tr>
<td>leastconn</td>
<td>加权最少连接，表示最少连接者优先处理</td>
</tr>
<tr>
<td>source</td>
<td>表示根据请求源IP，这个跟Nginx的IP_hash机制类似，使用其作为解决session问题的一种方法</td>
</tr>
<tr>
<td>uri</td>
<td>表示根据请求的URL，调度到后端不同的服务器</td>
</tr>
<tr>
<td>url_param</td>
<td>表示根据请求的URL参数来进行调度</td>
</tr>
<tr>
<td>hdr（name）</td>
<td>表示根据HTTP请求头来锁定每一次HTTP请求</td>
</tr>
<tr>
<td>rdp-cookie（name）</td>
<td>表示根据cookie（name）来锁定并哈希每一次TCP请求</td>
</tr>
</tbody></table>
<h5 id="启动访问"><a href="#启动访问" class="headerlink" title="启动访问"></a>启动访问</h5><ol>
<li>启动HAProxy：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/haproxy/sbin/haproxy -f /usr/local/haproxy/haproxy.conf</span><br></pre></td></tr></table></figure>



<ol start="2">
<li>查看HAProxy进程：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef|grep haproxy</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210528153132223.png" alt="image-20210528153132223"></p>
<ol start="3">
<li>访问</li>
</ol>
<p><a target="_blank" rel="noopener" href="http://192.168.192.159:8888/admin">http://192.168.192.159:8888/admin</a></p>
<p>   界面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210528153356137.png" alt="image-20210528153356137">  </p>
<h4 id="Keepalived安装配置"><a href="#Keepalived安装配置" class="headerlink" title="Keepalived安装配置"></a>Keepalived安装配置</h4><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210528153439544.png" alt="image-20210528153439544" style="zoom: 50%;" /> 

<ol>
<li><p>Keepalived之间维持一个心跳，如果与VIP绑定的Keepalived挂掉，则另外一台Keepalived立刻获得VIP绑定，执行请求分发功能。</p>
</li>
<li><p>当位于绑定VIP的Keepalived上的HAProxy挂掉后，Keepalived无法执行分发功能，但是另外一台的Keepalived仍然可以监控到该Keepalived存活，不能获得VIP绑定，这时这台Keepalived会试图重启HAProxy，如果启动不成功，Keepalived的脚本文件会将自己挂掉（自杀），之后另外一台Keepalived会立刻与VIP绑定，执行请求分发功能。</p>
</li>
</ol>
<h5 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h5><p>在两台服务器上均安装HAProxy（159/160），并进行配置。</p>
<ol>
<li>上传安装包到Linux：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alt + p --------&gt; put D:/tmp/keepalived-1.4.5.tar.gz</span><br></pre></td></tr></table></figure>



<ol start="2">
<li>解压安装包到目录 /usr/local/src：</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf keepalived-1.4.5.tar.gz -C /usr/<span class="built_in">local</span>/src</span><br></pre></td></tr></table></figure>



<ol start="3">
<li>安装依赖插件：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gcc openssl-devel popt-devel</span><br></pre></td></tr></table></figure>



<ol start="4">
<li>进入解压后的目录，进行配置和编译：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/keepalived-1.4.5</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/keepalived</span><br></pre></td></tr></table></figure>



<ol start="5">
<li>进行编译，完成后进行安装：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>



<ol start="6">
<li>运行前配置：</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/<span class="built_in">local</span>/src/keepalived-1.4.5/keepalived/etc/init.d/keepalived /etc/init.d/</span><br><span class="line">mkdir /etc/keepalived</span><br><span class="line">cp /usr/<span class="built_in">local</span>/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/</span><br><span class="line">cp /usr/<span class="built_in">local</span>/src/keepalived-1.4.5/keepalived/etc/sysconfig/keepalived /etc/sysconfig/</span><br><span class="line">cp /usr/<span class="built_in">local</span>/keepalived/sbin/keepalived /usr/sbin/</span><br></pre></td></tr></table></figure>



<ol start="7">
<li>修改配置文件 /etc/keepalived/keepalived.conf：</li>
</ol>
<ul>
<li>Master: 192.168.192.159</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">	notification_email &#123;</span><br><span class="line">		javadct@163.com</span><br><span class="line">	&#125;</span><br><span class="line">	notification_email_from keepalived@showjoy.com</span><br><span class="line">	smtp_server 127.0.0.1</span><br><span class="line">	smtp_connect_timeout 30</span><br><span class="line">	router_id haproxy01  #标识</span><br><span class="line">	vrrp_skip_check_adv_addr</span><br><span class="line">	vrrp_garp_interval 0</span><br><span class="line">	vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">	script &quot;&#x2F;etc&#x2F;keepalived&#x2F;haproxy_check.sh&quot;</span><br><span class="line">	interval 2</span><br><span class="line">	weight 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	#主机配MASTER，备机配BACKUP</span><br><span class="line">	state MASTER</span><br><span class="line">	#所在机器网卡</span><br><span class="line">	interface eth1</span><br><span class="line">	virtual_router_id 51</span><br><span class="line">	#数值越大优先级越高，越容易抢占</span><br><span class="line">	priority 120</span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 1111</span><br><span class="line">	&#125;</span><br><span class="line">	## 将 track_script 块加入 instance 配置块</span><br><span class="line">    track_script &#123;</span><br><span class="line">    	chk_haproxy ## 检查 HAProxy 服务是否存活</span><br><span class="line">    &#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		#虚拟IP</span><br><span class="line">		192.168.192.200</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>BackUP: 1921.68.192.160</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">	notification_email &#123;</span><br><span class="line">		javadct@163.com</span><br><span class="line">	&#125;</span><br><span class="line">	notification_email_from keepalived@showjoy.com</span><br><span class="line">	smtp_server 127.0.0.1</span><br><span class="line">	smtp_connect_timeout 30</span><br><span class="line">	#标识本节点</span><br><span class="line">	router_id haproxy02</span><br><span class="line">	vrrp_skip_check_adv_addr</span><br><span class="line">	vrrp_garp_interval 0</span><br><span class="line">	vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># keepalived 会定时执行脚本并对脚本执行的结果进行分析，动态调整 vrrp_instance 的优先级</span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">	# 检测 haproxy 状态的脚本路径</span><br><span class="line">	script &quot;&#x2F;etc&#x2F;keepalived&#x2F;haproxy_check.sh&quot;</span><br><span class="line">	#检测时间间隔</span><br><span class="line">	interval 2</span><br><span class="line">	#如果条件成立，权重+2</span><br><span class="line">	weight 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	#主机配MASTER，备机配BACKUP</span><br><span class="line">	state BACKUP</span><br><span class="line">	#所在机器网卡</span><br><span class="line">	interface eth1</span><br><span class="line">	virtual_router_id 51</span><br><span class="line">	#数值越大优先级越高</span><br><span class="line">	priority 100</span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 1111</span><br><span class="line">	&#125;</span><br><span class="line">	## 将 track_script 块加入 instance 配置块</span><br><span class="line">    track_script &#123;</span><br><span class="line">    	chk_haproxy ## 检查 HAProxy 服务是否存活</span><br><span class="line">    &#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		#虚拟IP</span><br><span class="line">		192.168.192.200</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol start="8">
<li>编写检测haproxy的shell脚本 在/etc/keepalived/haproxy_check.sh， haproxy_check.sh：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">A=`ps -C haproxy --no-header | wc -l`</span><br><span class="line"></span><br><span class="line">if [ $A -eq 0 ];then</span><br><span class="line"></span><br><span class="line">  /usr/local/haproxy/sbin/haproxy -f /usr/local/haproxy/haproxy.conf</span><br><span class="line"></span><br><span class="line">  echo &quot;haproxy restart ...&quot; &amp;&gt; /dev/null</span><br><span class="line"></span><br><span class="line">  sleep 1</span><br><span class="line"></span><br><span class="line">  if [ `ps -C haproxy --no-header | wc -l` -eq 0 ];then</span><br><span class="line"></span><br><span class="line">    /etc/init.d/keepalived stop</span><br><span class="line"></span><br><span class="line">    echo &quot;stop keepalived&quot; &amp;&gt; /dev/null</span><br><span class="line"></span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>



<h5 id="启动测试"><a href="#启动测试" class="headerlink" title="启动测试"></a>启动测试</h5><ol>
<li>启动Keepalived：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service keepalived start</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>登录验证：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p123456 -h 192.168.192.200 -P 48066</span><br></pre></td></tr></table></figure>

<p>上面语句其实也是访问HAProxy，进而访问到MySQL中的数据信息。</p>
<p>当主节点挂掉之后，备用节点与VIP进行绑定，而当主节点重新启用后，主节点重新与VIP进行绑定，而备用节点仍然是备用节点。</p>
<p>要想知道VIP与哪台服务器绑定可以使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arp -a 地址  </span><br></pre></td></tr></table></figure>



<h2 id="MyCat架构剖析"><a href="#MyCat架构剖析" class="headerlink" title="MyCat架构剖析"></a>MyCat架构剖析</h2><h3 id="MyCat总体架构介绍"><a href="#MyCat总体架构介绍" class="headerlink" title="MyCat总体架构介绍"></a>MyCat总体架构介绍</h3><h4 id="源码下载及导入"><a href="#源码下载及导入" class="headerlink" title="源码下载及导入"></a>源码下载及导入</h4><p> <img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529082401450.png" alt="image-20210529082401450"></p>
<p>导入编辑器： </p>
<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529160150015.png" alt="image-20210529160150015"> </p>
<h4 id="总体架构"><a href="#总体架构" class="headerlink" title="总体架构"></a>总体架构</h4><p>MyCat在逻辑上由几个模块组成：通信协议、路由解析、结果集处理、数据库连接、监控等模块。如图所示： </p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210528190944761.png" alt="image-20210528190944761" style="zoom: 50%;" /> 

<ol>
<li><p>通信协议模块： 通信协议模块承担底层的收发数据、线程回调处理工作， MyCat通信协议默认采用Reactor模式，在协议层采用MySQL协议；</p>
</li>
<li><p>路由解析模块：负责对传入的SQL语句进行语法解析，解析语句的条件、类型、关键字等，并进行优化；</p>
</li>
<li><p>SQL执行模块：负责从连接池中获取连接，再根据路由解析的结果，把SQL语句分发到相应的节点执行;</p>
</li>
<li><p>数据库链接模块：负责创建、管理、维护后端的连接池。为减少每次建立数据库连接的开销，数据库使用连接池机制对连接声明周期进行管理；</p>
</li>
<li><p>结果集处理模块：负责对跨分片的查询结果进行汇聚、排序、截取等；</p>
</li>
<li><p>监控管理模块：负责MyCat的连接、内存等资源进行监控和管理。监控主要通过管理指令及监控服务展现一些监控数据； 管理则主要通过轮询事件来检测和释放不适用的资源。</p>
</li>
</ol>
<h4 id="总体执行流程"><a href="#总体执行流程" class="headerlink" title="总体执行流程"></a>总体执行流程</h4><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210528191042826.png" alt="image-20210528191042826" style="zoom:50%;" /> 



<h3 id="MyCat网络I-O架构及实现"><a href="#MyCat网络I-O架构及实现" class="headerlink" title="MyCat网络I/O架构及实现"></a>MyCat网络I/O架构及实现</h3><h4 id="BIO、NIO与AIO"><a href="#BIO、NIO与AIO" class="headerlink" title="BIO、NIO与AIO"></a>BIO、NIO与AIO</h4><ol>
<li>BIO</li>
</ol>
<p>BIO(同步阻塞I/O) 通常由一个单独的Acceptor线程负责监听客户端的连接，接收到客户端的连接请求后，会为每个客户端创建一个新的线程进行处理，处理完成之后，再给客户端返回结果，销毁线程 。</p>
<p>每个客户端请求接入时，都需要开启一个线程进行处理，一个线程只能处理一个客户端连接。 当客户端变多时，会创建大量的处理线程，每个线程都需要分配栈空间和CPU，并且频繁的线程上下文切换也会造成性能的浪费，所以该模式无法满足高性能、高并发接入的需求。</p>
<ol start="2">
<li>NIO</li>
</ol>
<p>NIO(同步非阻塞I/O)基于Reactor模式作为底层通信模型，Reactor模式可以将事件驱动的应用进行事件分派，将客户端发送过来的服务请求分派给合适的处理类(handler)。当Socket有流可读或可写入Socket时，操作系统会通知相应的应用程序进行处理，应用程序再将流读取到缓冲区或写入操作系统。这时已经不是一个连接对应一个处理线程了，而是一个有效的请求对应一个线程，当没有数据时，就没有工作线程来处理。</p>
<p>NIO 的最大优点体现在线程轮询访问Selector，当read或write到达时则处，未到达时则继续轮询。</p>
<ol start="3">
<li>AIO</li>
</ol>
<p>AIO是全程 Asynchronous IO(异步非阻塞的IO)，是一种非阻塞异步的通信模式。在NIO的基础上引入了新的异步通道的概念，并提供了异步文件通道和异步套接字通道的实现。AIO中客户端的I/O请求都是由OS先完成了再通知服务器应用去启动线程进行处理。</p>
<p>AIO与NIO的主要区别在于回调与轮询，客户端不需要关注服务处理事件是否完成，也不需要轮询，只需要关注自己的回调函数。</p>
<h4 id="通信架构"><a href="#通信架构" class="headerlink" title="通信架构"></a>通信架构</h4><p>在MyCat中实现了NIO与AIO两种I/O模式，可以通过配置文件server.xml进行指定 : </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;usingAIO&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>usingAIO为1代表使用AIO模型，为0表示使用NIO模型。</p>
<p><strong>MyCat的AIO架构</strong></p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529161255070.png" alt="image-20210529161255070" style="zoom:50%;" /> 

<ol>
<li><p>MyCatStartUp是整个MyCat服务启动的入口；</p>
</li>
<li><p>在获取到MyCat的home目录后，把主要的任务交给MyCatServer，并调用其startup方法；</p>
</li>
<li><p>初始化系统配置，获取配置文件中的usingAIO的配置，如果配置为1，说明使用AIO模型，进入到AIO的分支，并创建两个连接，一个是管理后台连接(9066)，一个server的连接(8066)；</p>
</li>
<li><p>进入AIO分支，主要有AIOAcceptor接收客户端请求，绑定端口，创建服务端的异步Socket；在accept方法中完成两件事: ①FrontedConnection的创建，这是前段连接的关键; ② register注册事件，MySQL协议握手包就在此时发送。</p>
</li>
</ol>
<p>AIOAcceptor的accept方法 ： </p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529164017969.png" alt="image-20210529164017969" style="zoom:50%;" /> 



<p><strong>MyCat的NIO架构</strong></p>
<p>如果设置的usingAIO为0，那么将走NIOAcceptor通道，流程如下： </p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529164113087.png" alt="image-20210529164113087" style="zoom:50%;" /> 

<ol>
<li><p>如果走NIO分支，将首先创建NIOAcceptor对象，并调用其start方法；</p>
</li>
<li><p>NIOAcceptor 负责处理Accept事件，服务端接收客户端的连接事件，就是MyCat作为服务端去处理前端业务程序发过来的连接请求， 建立连接后，调用NIOAcceptor的NIOReactor.postRegister方法进行注册（并没有注解注册，而是放入缓冲队列，避免加锁的竞争）。 </p>
</li>
</ol>
<p>NIOAcceptor的accept方法 ： </p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529164242242.png" alt="image-20210529164242242" style="zoom:50%;" /> 



<h3 id="Mycat实现MySQL协议"><a href="#Mycat实现MySQL协议" class="headerlink" title="Mycat实现MySQL协议"></a>Mycat实现MySQL协议</h3><h4 id="MySQL协议简介"><a href="#MySQL协议简介" class="headerlink" title="MySQL协议简介"></a>MySQL协议简介</h4><h5 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h5><p>MySQL协议处于应用层之下、TCP/IP之上，在MySQL客户端和服务端之间使用。包含了链接器、MySQL代理、主从复制服务器之间通信，并支持SSL加密、传输数据的压缩、连接和身份验证及数据交互等。其中，握手认证阶段和命令执行阶段是MySQL协议中的两个重要阶段。</p>
<h5 id="握手认证阶段"><a href="#握手认证阶段" class="headerlink" title="握手认证阶段"></a>握手认证阶段</h5><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529162549815.png" alt="image-20210529162549815" style="zoom:50%;" /> 

<ol>
<li><p>握手认证阶段是客户端连接服务器的必经之路，客户端与服务端完成TCP的三次握手以后，服务端会向客户端发送一个初始化握手包，握手包中包含了协议版本、MySQLServer版本、线程ID、服务器的权能标识和字符集等信息。</p>
</li>
<li><p>客户端在接收到服务端的初始化握手包之后，会发送身份验证包给服务端（AuthPacket），该包中包含用户名、密码等信息。</p>
</li>
<li><p>服务端接收到客户端的登录验证包之后，需要进行逻辑校验，校验该登录信息是否正确。如果信息都符合，则返回一个OKPacket，表示登录成功，否则返回ERR_Packet，表示拒绝。</p>
</li>
</ol>
<p>Wireshark抓包如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529162841533.png" alt="image-20210529162841533"> </p>
<p>报文分析如下： </p>
<ol>
<li>初始化握手包：</li>
</ol>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529163131557.png" alt="image-20210529163131557" style="zoom:50%;" /> 

<p>通过抓包工具Wireshark抓取到的握手包信息如下：</p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529164324303.png" alt="image-20210529164324303" style="zoom:50%;" />  

<p>说明：</p>
<ul>
<li><p>Packet Length：包的长度</p>
</li>
<li><p>Packet Number：包的序号</p>
</li>
<li><p>Server Greeting：消息体，包含了协议版本、MySQLServer版本、线程ID和字符集等信息。 </p>
</li>
</ul>
<ol start="2">
<li>登录认证包</li>
</ol>
<p>客户端在接收到服务端发来的初始握手包之后，向服务端发出认证请求，该请求包含以下信息（由Wireshark抓获）： </p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529164431474.png" alt="image-20210529164431474" style="zoom:50%;" /> 



<ol start="3">
<li>OK包或ERROR包</li>
</ol>
<p>服务端接收到客户端的登录认证包之后，如果通过认证，则返回一个OKPacket，如果未通过认证，则返回一个ERROR包。</p>
<p>OK报文如下： </p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529164511413.png" alt="image-20210529164511413" style="zoom:50%;" /> 

<p>ERROR报文如下：</p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529164537597.png" alt="image-20210529164537597" style="zoom:50%;" /> 



<h5 id="命令执行阶段"><a href="#命令执行阶段" class="headerlink" title="命令执行阶段"></a>命令执行阶段</h5><p>在握手认证阶段通过并完成以后，客户端可以向服务端发送各种命令来请求数据，此阶段的流程是：命令请求-&gt;返回结果集。</p>
<p>Wireshark 捕获的数据包如下： </p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529164707467.png" alt="image-20210529164707467" style="zoom:50%;" /> 

<ol>
<li>命令包：</li>
</ol>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529164733540.png" alt="image-20210529164733540" style="zoom:50%;" /> 

<ol start="2">
<li>结果集包：</li>
</ol>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529165457373.png" alt="image-20210529165457373" style="zoom:50%;" /> 



<h4 id="MySQL协议在MyCat中实现"><a href="#MySQL协议在MyCat中实现" class="headerlink" title="MySQL协议在MyCat中实现"></a>MySQL协议在MyCat中实现</h4><h5 id="握手认证实现"><a href="#握手认证实现" class="headerlink" title="握手认证实现"></a>握手认证实现</h5><p>在MyCat中同时实现了NIO和AIO，通过配置可以选择NIO和AIO。MyCat Server在启动阶段已经选择好采用NIO还是AIO，因此建立I/O通道后，MyCat服务端一直等待客户端的连接，当有连接到来的时候，MyCat首先发送握手包。 </p>
<ol>
<li>握手包源码实现：MyCat源码中io.mycat.net.FrontendConnection类的实现如下：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20200127183259378.png" alt="image-20200127183259378"> </p>
<p>握手包信息组装完毕后，通过FrontedConnection写回客户端。</p>
<ol start="2">
<li>认证包源码实现</li>
</ol>
<p>客户端接收到握手包后，紧接着向服务端发起一个认证包，MyCat封装为类 AuthPacket：</p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529165547943.png" alt="image-20210529165547943" style="zoom:50%;" /> 

<p>客户端发送的认证包转由 FrontendAuthenticator 的Handler来处理，主要操作就是 拆包，检查用户名、密码合法性，检查连接数是够超出限制。源码实现如下： </p>
<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20200127232022594.png" alt="image-20200127232022594"> </p>
<p>认证失败，调用failure方法，认证成功调用success方法。</p>
<p>failure方法源码： </p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529165726080.png" alt="image-20210529165726080" style="zoom:50%;" /> 

<p>success方法源码： </p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529165801988.png" alt="image-20210529165801988" style="zoom:50%;" /> 



<h5 id="命令执行实现"><a href="#命令执行实现" class="headerlink" title="命令执行实现"></a>命令执行实现</h5><p>命令执行阶段就是SQL命令和SQL语句执行阶段，在该阶段MyCat主要需要做的事情，就是对客户端发来的数据包进行拆包，并判断命令的类型，并解析SQL语句，执行响应的SQL语句，最后把执行结果封装在结果集包中，返回给客户端。</p>
<p>从客户端发来的命令交给 FrontendCommandHandler 中的handle方法处理：</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20200127235140959.png" alt="image-20200127235140959"> </p>
<p>处理具体的请求，返回客户端结果集数据包：</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20200128000050787.png" alt="image-20200128000050787"> </p>
<h3 id="MyCat线程架构与实现"><a href="#MyCat线程架构与实现" class="headerlink" title="MyCat线程架构与实现"></a>MyCat线程架构与实现</h3><h4 id="MyCat线程池实现"><a href="#MyCat线程池实现" class="headerlink" title="MyCat线程池实现"></a>MyCat线程池实现</h4><p>在MyCat中大量用到了线程池，通过线程池来避免频繁的创建和销毁线程而造成的系统性能的浪费。在MyCat中使用的线程池是JDK中提供的线程池 ThreadPoolExecutor 的子类 NameableExecutor ， 构造方法如下： </p>
<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20200108114506434.png" alt="image-20200108114506434"> </p>
<p>父类构造为： </p>
<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20200108114611505.png" alt="image-20200108114611505"> </p>
<p>构造参数含义：</p>
<ul>
<li><p>corePoolSize : 核心池大小</p>
</li>
<li><p>maximumPoolSize : 最大线程数 </p>
</li>
<li><p>keepAliveTime: 线程没有任务执行时，最多能够存活多久</p>
</li>
<li><p>timeUnit: 时间单位 </p>
</li>
<li><p>workQueue: 阻塞任务队列</p>
</li>
<li><p>threadFactory: 线程工厂，用来创建线程</p>
</li>
</ul>
<h4 id="MyCat线程架构"><a href="#MyCat线程架构" class="headerlink" title="MyCat线程架构"></a>MyCat线程架构</h4><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529170443397.png" alt="image-20210529170443397" style="zoom:50%;" /> 

<p>在MyCat中主要有两大线程池：timerExecutor 和 businessExecutor。</p>
<ol>
<li><p>timerExecutor 线程池主要完成系统时间定时更新、处理器定时检查、数据节点定时连接、空闲超时检查、数据节点定时心跳检测等任务。</p>
</li>
<li><p>businessExecutor是MyCat最重要的线程资源池，该资源池的线程使用的范围非常广，涵盖以下方面： </p>
<ul>
<li>后端用原生协议连接数据</li>
<li>JDBC执行SQL语句</li>
<li>SQL拦截</li>
<li>数据合并服务</li>
<li>批量SQL作业</li>
<li>查询结果的异步分发</li>
<li>基于guava实现异步回调</li>
</ul>
</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20200108141645417.png" alt="image-20200108141645417"> </p>
<h3 id="MyCat内存管理及缓存框架与实现"><a href="#MyCat内存管理及缓存框架与实现" class="headerlink" title="MyCat内存管理及缓存框架与实现"></a>MyCat内存管理及缓存框架与实现</h3><p>这里所提到的内存管理指的是MyCat缓冲区管理，众所周知设置缓冲区的唯一目的是提高系统的性能，缓冲区通常是部分常用的数据存放在缓冲池中以便系统直接访问，避免使用磁盘IO访问磁盘数据，从而提高性能。</p>
<h4 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h4><ol>
<li><p>缓冲池组成：缓冲池的最小单位为chunk，默认的chunk大小为4096字节(DEFAULT_BUFFER_CHUNK_SIZE)，BufferPool的总大小为4096 x processors x 1000(其中processors为处理器数量)。对I/O进程而言，他们共享一个缓冲池。缓冲池有两种类型：本地缓存线程（以$_开头的线程）缓冲区和其他缓冲区，分配buffer时，优先获取ThreadLocalPool中的buffer，没有命中时会获取BufferPool中的buffer。</p>
</li>
<li><p>分配MyCat缓冲池：分配缓冲池时，可以指定大小，也可以用默认值。</p>
<ul>
<li>allocate()：先检测是否为本地线程，当执行线程为本地缓存线程时，localBufferPool取出一个可用的buffer。如果不是，则从ConcurrentLinkedQueue队列中取出一个buffer进行分配，如果队列没有可用的buffer，则创建一个直接缓冲区。</li>
<li>allocate(size)：如果用户指定的size不大于chunkSize，则调用allocate()进行分配；反之则调用createTempBuffer(size)创建临时非直接缓冲区。</li>
</ul>
</li>
</ol>
<ol start="3">
<li>MyCat缓冲池的回收：回收时先判断buffer是否有效，有如下情况时缓冲池不回收。<ul>
<li>不是直接缓冲区</li>
<li>buffer是空的</li>
<li>buffer的容量大于chunkSize</li>
</ul>
</li>
</ol>
<h4 id="MyCat缓存架构"><a href="#MyCat缓存架构" class="headerlink" title="MyCat缓存架构"></a>MyCat缓存架构</h4><ol>
<li>缓存框架选择：MyCat支持ehcache、mapdb、leveldb缓存，可通过配置文件cacheserver.properties来进行配置：</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20200108154627518.png" alt="image-20200108154627518"> </p>
<ol start="2">
<li>缓存内容：MyCat有路由缓存、表主键到datanode缓存、ER关系缓存。<ul>
<li>路由缓存: 即SQLRouteCache, 根据SQL语句查找路由信息的缓存, 该缓存只是针对select语句, 如果执行了之前已经执行过的某个SQL语句(缓存命中), 那么路由信息就不需要重复计算了, 直接从缓存中获取。</li>
<li> 表主键到datanode缓存: 当分片字段与主键字段不一致时, 直接通过主键值查询时无法定位具体分片的(只能全分片下发), 所以设置该缓存之后, 就可以利用主键值查找到分片名, 缓存的key是ID值, value是节点名。</li>
<li> ER关系缓存: 在ER分片时使用, 而且在insert查询中才会使用缓存, 当子表插入数据时, 根据父子关联字段确定子表分片, 下次可以直接从缓存中获取所在的分片。 </li>
</ul>
</li>
</ol>
<p>查看缓存指令： show @@cache；</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20200108155642414.png" alt="image-20200108155642414"> </p>
<h3 id="MyCat连接池架构与实现"><a href="#MyCat连接池架构与实现" class="headerlink" title="MyCat连接池架构与实现"></a>MyCat连接池架构与实现</h3><p>这里所讨论的连接池是MyCat的后端连接池，也就是MyCat后端与各个数据库节点之间的连接架构。</p>
<ol>
<li><p>连接池创建：MyCat按照每个dataHost创建一个连接池，根据schema.xml文件的配置取得最小的连接数minCon，并初始化minCon个连接。在初始化连接时，还需要判定用户选择的是JDBC还是原生的MySQL协议，以便于创建对应的连接。</p>
</li>
<li><p>连接池分配：分配连接就是从连接池队列中取出一个连接，在取出一个连接时，MyCat需要根据负载均衡（balance属性）的类型选择不同的数据源，因为连接和数据源绑在一起，所以需要知道MyCat读写的是那些数据源，才能分配响应的连接。 </p>
</li>
<li><p>架构：</p>
</li>
</ol>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20210529171853415.png" alt="image-20210529171853415" style="zoom:50%;" /> 



<h3 id="MyCat主从切换架构与实现"><a href="#MyCat主从切换架构与实现" class="headerlink" title="MyCat主从切换架构与实现"></a>MyCat主从切换架构与实现</h3><h4 id="MyCat主从切换概述"><a href="#MyCat主从切换概述" class="headerlink" title="MyCat主从切换概述"></a>MyCat主从切换概述</h4><p>MyCat实现MySQL读写分离的目的在于降低单节点数据库的访问压力,  原理就是让主数据库执行增删改操作，从数据库执行查询操作，利用MySQL数据库的复制机制将Master的数据同步到slave上。</p>
<p>当master宕机后，slave承载的业务如何切换到master继续提供服务，以及slave宕机后如何将master切换到slave上。手动切换数据源很简单， 但不是运维工作的首选，本节重点就是讲解如何实现自动切换。</p>
<p>MyCat的读写分离依赖于MySQL的主从同步，也就是说MyCat没有实现数据的主从同步功能，但是实现了自动切换功能。</p>
<p><strong>1). 自动切换</strong></p>
<p>自动切换是MyCat主从复制的默认配置，当主机或从机宕机后，MyCat自动切换到可用的服务器上。假设写服务器为M，读服务器为S， 则： </p>
<ul>
<li><p>正常时，写M读S； </p>
</li>
<li><p>当M宕机后，读写S；恢复M后，写S，读M；</p>
</li>
<li><p>当S宕机后，读写M；恢复S后，写M，读S 。</p>
</li>
</ul>
<p><strong>2). 基于MySQL主从同步状态的切换</strong></p>
<p>这种切换方式与自动切换不同，MyCat检测到主从数据同步延迟时，<strong>会自动切换到拥有最新数据的MySQL服务器上</strong>，防止读到很久以前的数据。</p>
<p>原理就是通过检查MySQL的主从同步状态（show slave status）中的Seconds_Behind_Master、Slave_IO_Running、Slave_SQL_Running三个字段，来确定当前主从同步的状态以及主从之间的数据延迟。 Seconds_Behind_Master为0表示没有延迟，数值越大，则说明延迟越高。</p>
<h4 id="MyCat主从切换实现"><a href="#MyCat主从切换实现" class="headerlink" title="MyCat主从切换实现"></a>MyCat主从切换实现</h4><p>基于延迟的切换，则判断结果集中的Slave_IO_Running、Slave_SQL_Running两个个字段是否都为yes，以及Seconds_Behind_Master 是否小于配置文件中配置的 slaveThreshold的值，如果有其中任何一个条件不满足，则切换。</p>
<p>主要流程如下：</p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20200128005840029.png" alt="image-20200128005840029" style="zoom:80%;" /> 





<h3 id="MyCat核心技术"><a href="#MyCat核心技术" class="headerlink" title="MyCat核心技术"></a>MyCat核心技术</h3><h4 id="MyCat分布式事务实现"><a href="#MyCat分布式事务实现" class="headerlink" title="MyCat分布式事务实现"></a>MyCat分布式事务实现</h4><p>MyCat在1.6版本以后已经支持XA分布式事务类型了。具体的使用流程如下：</p>
<ol>
<li>在应用层需要设置事务不能自动提交：</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> autocommit<span class="operator">=</span><span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在SQL中设置XA为开启状态：</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> xa <span class="operator">=</span> <span class="keyword">on</span>;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>执行SQL：</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(id,name,sex) <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;Tom&#x27;</span>,<span class="string">&#x27;1&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;Rose&#x27;</span>,<span class="string">&#x27;2&#x27;</span>),(<span class="number">3</span>,<span class="string">&#x27;Leo&#x27;</span>,<span class="string">&#x27;1&#x27;</span>),(<span class="number">4</span>,<span class="string">&#x27;Lee&#x27;</span>,<span class="string">&#x27;1&#x27;</span>);</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>对事务进行提交或回滚：</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">commit</span><span class="operator">/</span><span class="keyword">rollback</span></span><br></pre></td></tr></table></figure>

<p>完整流程如下: </p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20200129223657058.png" alt="image-20200129223657058" style="zoom:80%;" /> 





<h4 id="MyCat-SQL路由实现"><a href="#MyCat-SQL路由实现" class="headerlink" title="MyCat SQL路由实现"></a>MyCat SQL路由实现</h4><p>MyCat的路由是和SQL解析组件息息相关的，SQL路由模块是MyCat数据库中间件最重要的模块之一，使用MyCat主要是为了分库分表，而分库分表的核心就是路由。</p>
<h5 id="路由的作用"><a href="#路由的作用" class="headerlink" title="路由的作用"></a>路由的作用</h5><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20200113225535847.png" alt="image-20200113225535847" style="zoom:80%;" /> 

<p>如图所示，MyCat接收到应用系统发来的查询语句，要将其发送到后端连接的MySQL数据库去执行，但是后端有三个数据库服务器，具体要查询那一台数据库服务器呢，这就是路由需要实现的功能。SQL的路由既要保证数据的完整，也不能造成资源的浪费，还要保证路由的效率。</p>
<h5 id="SQL解析器"><a href="#SQL解析器" class="headerlink" title="SQL解析器"></a>SQL解析器</h5><p>Mycat1.3版本之前模式使用的是Fdbparser的foundationdb的开源SQL解析器，在2015年被apple收购后，从开源变为闭源了。</p>
<p>目前版本的MyCat采用的是Druid的SQL解析器，性能比采用Fdbparser整体性能提高20%以上。</p>
<h4 id="MyCat跨库Join"><a href="#MyCat跨库Join" class="headerlink" title="MyCat跨库Join"></a>MyCat跨库Join</h4><h5 id="全局表"><a href="#全局表" class="headerlink" title="全局表"></a>全局表</h5><p>每个企业级的系统中，都会存在一些系统的基础信息表，类似于字典表、省份、城市、区域、语言表等，这些表与业务表之间存在关系， 但不是业务主从关系，而是一种属性关系。当我们对业务表进行分片处理时，可以将这些基础信息表设置为全局表，也就是在每个节点中都存在该表。</p>
<p>全局表的特性如下： </p>
<ol>
<li><p>全局表的insert、update、delete操作会实时地在所有节点同步执行，保持各个节点数据的一致性；</p>
</li>
<li><p>全局表的查询操作会从任意节点执行，因为所有节点的数据都一致；</p>
</li>
<li><p>全局表可以和任意表进行join操作。</p>
</li>
</ol>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20200128013501684.png" alt="image-20200128013501684" style="zoom:80%;" /> 



<h5 id="ER表"><a href="#ER表" class="headerlink" title="ER表"></a>ER表</h5><p>关系型数据库是基于实体关系模型(Entity Relationship Model)的，MyCat中的ER表便来源于此。MyCat提出了基于ER关系的数据分片策略，子表的记录与其所关联的父表的记录存放在同一个数据分片中，通过表分组(Table Group)保证数据关联查询不会跨库操作。</p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20200129101108379.png" alt="image-20200129101108379" style="zoom:80%;" /> 

<h5 id="catlet"><a href="#catlet" class="headerlink" title="catlet"></a>catlet</h5><p>catlet是MyCat为了解决跨分片Join提出的一种创新思路，也叫做人工智能(HBT)。MyCat参考了数据库中存储过程的实现方式，提出类似的跨库解决方案，用户可以根据系统提供的API接口实现跨分片Join。采用这种方案开发时，必须要实现Catlet接口的两个方法：</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20200129104415975.png" alt="image-20200129104415975"> </p>
<p>route 方法：路由的方法，传递系统配置和schema配置等 ;</p>
<p>processSQL方法：EngineCtx执行SQL并给客户端返回结果集 。</p>
<p>当自定义Catlet完成之后，需要将Catlet的实现类进行编译，并将其字节码文件 XXXCatlet.class存放在mycat_home/catlet目录下，系统会加载相关Class，而且每隔1分钟扫描一次文件是否更新，若更新则自动重新加载，因此无需重启服务。</p>
<p><strong>ShareJoin</strong></p>
<p>ShareJoin 是Catlet的实现，是一个简单的跨分片Join，目前支持两个表的Join，原理就是解析SQL语句，拆分成单表的语句执行，单后把各个节点的数据进行汇集。要想使用Catlet完成join，还需要借助于MyCat中的注解，在执行SQL语句时，使用catlet注解：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*!mycat:catlet=demo.catlets.ShareJoin */</span> <span class="keyword">select</span> a.id <span class="keyword">as</span> aid , a.id , b.id <span class="keyword">as</span> bid , b.name <span class="keyword">as</span> name <span class="keyword">from</span> customer a, company b <span class="keyword">where</span> a.company_id<span class="operator">=</span>b.id <span class="keyword">and</span> a.id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>



<h4 id="MyCat数据汇聚与排序"><a href="#MyCat数据汇聚与排序" class="headerlink" title="MyCat数据汇聚与排序"></a>MyCat数据汇聚与排序</h4><p>通过MyCat实现数据汇聚和排序，不仅可以减少各分片与客户端之间的数据传输IO，也可以帮助开发者总复杂的数据处理中解放出来，从而专注于开发业务代码。</p>
<p>在MySQL中存在两种排序方式：一种利用有序索引获取有序数据，另一种通过相应的排序算法将获取到的数据在内存中进行排序。而MyCat中数据排序采用堆排序法对多个分片返回有序数据，并在合并、排序后再返回给客户端。</p>
<img src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/image-20200129113055429.png" alt="image-20200129113055429" style="zoom:80%;" /> </article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">zhangc233</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://zhangc233.github.io/2021/05/26/MyCat%E2%80%94%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E5%8F%8A%E6%9E%B6%E6%9E%84%E5%89%96%E6%9E%90/">https://zhangc233.github.io/2021/05/26/MyCat%E2%80%94%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA%E5%8F%8A%E6%9E%B6%E6%9E%84%E5%89%96%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://zhangc233.github.io" target="_blank">ZC的学习录</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E9%97%B4%E4%BB%B6/">数据库中间件</a><a class="post-meta__tags" href="/tags/MyCat/">MyCat</a><a class="post-meta__tags" href="/tags/%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4/">高可用集群</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/mycat.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.png" target="_blank"><img class="post-qr-code-img" src="/img/wechat.png" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.png" target="_blank"><img class="post-qr-code-img" src="/img/alipay.png" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/05/26/MyCat%E2%80%94%E5%88%86%E7%89%87%E3%80%81%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E3%80%81%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB/"><img class="prev-cover" src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/mycat0.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">MyCat-分片、性能监控、读写分离</div></div></a></div><div class="next-post pull-right"><a href="/2021/05/23/MyCat%E2%80%94%E7%AE%80%E4%BB%8B%E3%80%81%E5%85%A5%E9%97%A8%E3%80%81%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/mycat.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MyCat-简介、入门、配置文件详解</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/05/23/MyCat—简介、入门、配置文件详解/" title="MyCat-简介、入门、配置文件详解"><img class="cover" src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/mycat.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-23</div><div class="title">MyCat-简介、入门、配置文件详解</div></div></a></div><div><a href="/2021/05/26/MyCat—分片、性能监控、读写分离/" title="MyCat-分片、性能监控、读写分离"><img class="cover" src="https://cdn.jsdelivr.net/gh/zhangc233/pic@master/img/mycat0.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-26</div><div class="title">MyCat-分片、性能监控、读写分离</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#MyCat%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">MyCat高可用集群搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text">集群架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MyCat%E5%AE%9E%E7%8E%B0%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.1.</span> <span class="toc-text">MyCat实现读写分离架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MyCat%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84"><span class="toc-number">1.1.2.</span> <span class="toc-text">MyCat集群架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MyCat%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4"><span class="toc-number">1.1.3.</span> <span class="toc-text">MyCat的高可用集群</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">1.2.</span> <span class="toc-text">高可用集群搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E7%8E%AF%E5%A2%83%E8%A7%84%E5%88%92"><span class="toc-number">1.2.1.</span> <span class="toc-text">部署环境规划</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%90%AD%E5%BB%BA"><span class="toc-number">1.2.2.</span> <span class="toc-text">MySQL主从复制搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#master"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">master</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#slave"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">slave</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">测试验证</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MyCat%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.3.</span> <span class="toc-text">MyCat安装配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#schema-xml"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">schema.xml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#server-xml"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">server.xml</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E9%AA%8C%E8%AF%81-1"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">测试验证</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HAProxy%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.4.</span> <span class="toc-text">HAProxy安装配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E8%AE%BF%E9%97%AE"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">启动访问</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Keepalived%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.5.</span> <span class="toc-text">Keepalived安装配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">安装配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">启动测试</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MyCat%E6%9E%B6%E6%9E%84%E5%89%96%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">MyCat架构剖析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MyCat%E6%80%BB%E4%BD%93%E6%9E%B6%E6%9E%84%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.</span> <span class="toc-text">MyCat总体架构介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD%E5%8F%8A%E5%AF%BC%E5%85%A5"><span class="toc-number">2.1.1.</span> <span class="toc-text">源码下载及导入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-number">2.1.2.</span> <span class="toc-text">总体架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E4%BD%93%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.3.</span> <span class="toc-text">总体执行流程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MyCat%E7%BD%91%E7%BB%9CI-O%E6%9E%B6%E6%9E%84%E5%8F%8A%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.2.</span> <span class="toc-text">MyCat网络I&#x2F;O架构及实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BIO%E3%80%81NIO%E4%B8%8EAIO"><span class="toc-number">2.2.1.</span> <span class="toc-text">BIO、NIO与AIO</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E4%BF%A1%E6%9E%B6%E6%9E%84"><span class="toc-number">2.2.2.</span> <span class="toc-text">通信架构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mycat%E5%AE%9E%E7%8E%B0MySQL%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.3.</span> <span class="toc-text">Mycat实现MySQL协议</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MySQL%E5%8D%8F%E8%AE%AE%E7%AE%80%E4%BB%8B"><span class="toc-number">2.3.1.</span> <span class="toc-text">MySQL协议简介</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">2.3.1.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%A1%E6%89%8B%E8%AE%A4%E8%AF%81%E9%98%B6%E6%AE%B5"><span class="toc-number">2.3.1.2.</span> <span class="toc-text">握手认证阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E9%98%B6%E6%AE%B5"><span class="toc-number">2.3.1.3.</span> <span class="toc-text">命令执行阶段</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MySQL%E5%8D%8F%E8%AE%AE%E5%9C%A8MyCat%E4%B8%AD%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.3.2.</span> <span class="toc-text">MySQL协议在MyCat中实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%A1%E6%89%8B%E8%AE%A4%E8%AF%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">握手认证实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">命令执行实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MyCat%E7%BA%BF%E7%A8%8B%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.4.</span> <span class="toc-text">MyCat线程架构与实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MyCat%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.4.1.</span> <span class="toc-text">MyCat线程池实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MyCat%E7%BA%BF%E7%A8%8B%E6%9E%B6%E6%9E%84"><span class="toc-number">2.4.2.</span> <span class="toc-text">MyCat线程架构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MyCat%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%8F%8A%E7%BC%93%E5%AD%98%E6%A1%86%E6%9E%B6%E4%B8%8E%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.5.</span> <span class="toc-text">MyCat内存管理及缓存框架与实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="toc-number">2.5.1.</span> <span class="toc-text">内存管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MyCat%E7%BC%93%E5%AD%98%E6%9E%B6%E6%9E%84"><span class="toc-number">2.5.2.</span> <span class="toc-text">MyCat缓存架构</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MyCat%E8%BF%9E%E6%8E%A5%E6%B1%A0%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.6.</span> <span class="toc-text">MyCat连接池架构与实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MyCat%E4%B8%BB%E4%BB%8E%E5%88%87%E6%8D%A2%E6%9E%B6%E6%9E%84%E4%B8%8E%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.7.</span> <span class="toc-text">MyCat主从切换架构与实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MyCat%E4%B8%BB%E4%BB%8E%E5%88%87%E6%8D%A2%E6%A6%82%E8%BF%B0"><span class="toc-number">2.7.1.</span> <span class="toc-text">MyCat主从切换概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MyCat%E4%B8%BB%E4%BB%8E%E5%88%87%E6%8D%A2%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.7.2.</span> <span class="toc-text">MyCat主从切换实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MyCat%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF"><span class="toc-number">2.8.</span> <span class="toc-text">MyCat核心技术</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MyCat%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.8.1.</span> <span class="toc-text">MyCat分布式事务实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MyCat-SQL%E8%B7%AF%E7%94%B1%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.8.2.</span> <span class="toc-text">MyCat SQL路由实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">2.8.2.1.</span> <span class="toc-text">路由的作用</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SQL%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-number">2.8.2.2.</span> <span class="toc-text">SQL解析器</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MyCat%E8%B7%A8%E5%BA%93Join"><span class="toc-number">2.8.3.</span> <span class="toc-text">MyCat跨库Join</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E8%A1%A8"><span class="toc-number">2.8.3.1.</span> <span class="toc-text">全局表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#ER%E8%A1%A8"><span class="toc-number">2.8.3.2.</span> <span class="toc-text">ER表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#catlet"><span class="toc-number">2.8.3.3.</span> <span class="toc-text">catlet</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MyCat%E6%95%B0%E6%8D%AE%E6%B1%87%E8%81%9A%E4%B8%8E%E6%8E%92%E5%BA%8F"><span class="toc-number">2.8.4.</span> <span class="toc-text">MyCat数据汇聚与排序</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 <i style="color:#FF6A6A;animation: announ_animation 0.8s linear infinite;" class="fa fa-heartbeat"></i> zhangc233</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my blog!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="chat_btn" type="button" title="rightside.chat_btn"><i class="fas fa-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (true){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>(()=>{
  const $countDom = document.getElementById('twikoo-count')
  const init = () => {
    let initData = {
      el: '#twikoo-wrap',
      envId: 'zc-cloudbase-7gbysfm74e2b2c22',
      region: ''
    }

    if (false) {
      const otherData = false
      initData = Object.assign(initData, otherData)
    }
    
    twikoo.init(initData)
  }

  const getCount = () => {
    twikoo.getCommentsCount({
      envId: 'zc-cloudbase-7gbysfm74e2b2c22',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      $countDom.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const loadTwikoo = (bool = false) => {
    if (typeof twikoo === 'object') {
      init()
      bool && $countDom && setTimeout(getCount,0)
    } else {
      getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(()=> {
        init()
        bool && $countDom && setTimeout(getCount,0)
      })
    }
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo(true)
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script><script src="https://cdn.jsdelivr.net/gh/lete114/CDN/Sum/sakura.js"></script><script src="https://cdn.jsdelivr.net/gh/lete114/CDN/Sum/title.js"></script><script src="/js/botui.js"></script><script data-pjax src="/js/botui_init.js"></script><script async src="/js/back.js"></script><script type="text/javascript" id="clstr_globe" src="//clustrmaps.com/globe.js?d=5V2tOKp8qAdRM-i8eu7ETTO9ugt5uKbbG-U7Yj8uMl8"></script><div class="aplayer no-destroy" data-id="000PeZCQ1i4XVs" data-server="tencent" data-type="artist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-preload="none" data-autoplay="true" muted></div><script src="/js/chatra.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script>(function(d, w, c) {
    w.ChatraID = 'bJrdHqZM78fLH3i3H';
    var s = d.createElement('script');
    w[c] = w[c] || function() {
        (w[c].q = w[c].q || []).push(arguments);
    };
    s.async = true;
    s.src = 'https://call.chatra.io/chatra.js';
    if (d.head) d.head.appendChild(s);
})(document, window, 'Chatra');

if (true) {
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      Chatra('openChat')
    });
  }
  chatBtnFn()
} else {
  if (true) {
    function chatBtnHide () {
      Chatra('hide')
    }
    function chatBtnShow () {
      Chatra('show')
    }
  }
}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  if (typeof gtag === 'function') {
    gtag('config', '', {'page_path': window.location.pathname});
  }

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})


document.addEventListener('pjax:send', function () {
  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right","width":150,"height":300,"hOffset":20,"vOffset":-20},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/"});</script></body></html>